# 管理员权限系统说明

## 功能概述

系统现在支持两种类型的管理员：

### 1. 超级管理员 (Super Admin)
- ✅ 查看所有教会数据
- ✅ 创建和管理普通管理员
- ✅ 为管理员分配教会
- ✅ 配置系统设置（签到URL等）
- ✅ 创建新教会
- ✅ 查看所有教会的成员和签到数据

**界面特点：**
- 登录后显示"超级管理"标签
- 包含三个子标签：
  - ⚙️ 系统配置：配置签到URL
  - 👥 管理员管理：创建、编辑、删除管理员
  - ⛪ 教会管理：查看和创建教会

### 2. 普通管理员 (Regular Admin)
- ✅ 管理被分配的教会
- ✅ 查看和管理教会成员
- ✅ 查看签到记录和统计
- ✅ 导出签到数据
- ❌ 无法创建教会
- ❌ 无法管理其他管理员

**界面特点：**
- 登录后没有"超级管理"标签
- 只能看到"今日签到"和"员工管理"标签

## 使用指南

### 初始化超级管理员

数据库迁移后，第一个创建的管理员会自动成为超级管理员。

```bash
cd server
node scripts/add_super_admin_and_config.js
```

### 超级管理员操作流程

1. **登录系统**
   - 使用超级管理员账号登录（默认：admin / admin123）
   - 系统自动识别超级管理员身份

2. **配置签到URL**
   - 进入"超级管理" → "系统配置"
   - 设置签到页面URL（如：https://yourdomain.com/sign）
   - 保存后，所有教会的二维码将使用新URL

3. **创建普通管理员**
   - 进入"超级管理" → "管理员管理"
   - 点击"创建管理员"
   - 填写用户名、密码
   - 选择该管理员可以管理的教会
   - 创建成功

4. **管理现有管理员**
   - 查看所有管理员列表
   - 编辑管理员的教会分配
   - 删除不需要的管理员（不能删除超级管理员）

5. **创建新教会**
   - 进入"超级管理" → "教会管理"
   - 点击"创建新教会"
   - 填写教会名称和代码
   - 创建后可在"管理员管理"中为其分配管理员

### 普通管理员操作流程

1. **登录系统**
   - 使用分配的账号密码登录
   - 自动显示被分配的教会

2. **切换教会**
   - 如果管理多个教会，可在顶部下拉框切换
   - 切换后数据自动更新

3. **管理员工**
   - 进入"员工管理"标签
   - 添加、编辑、删除员工信息

4. **查看签到数据**
   - "今日签到"标签显示当日签到情况
   - 可搜索、筛选、导出签到记录

## 数据库表结构

### admins 表
- `id` - 管理员ID
- `username` - 用户名
- `password` - 加密密码
- `is_super` - 是否为超级管理员（新增）
- `company_id` - 默认教会ID（兼容字段）

### system_config 表（新增）
- `id` - 配置ID
- `config_key` - 配置键
- `config_value` - 配置值
- `description` - 配置说明

### church_admins 表
- `id` - 关联ID
- `admin_id` - 管理员ID
- `church_id` - 教会ID
- `role` - 角色（manager/owner）

## API接口

### 超级管理员专用接口

所有接口都需要验证 `is_super` 权限：

- `GET /api/super/config` - 获取系统配置
- `PUT /api/super/config` - 更新系统配置
- `GET /api/super/admins` - 获取所有管理员
- `POST /api/super/admins` - 创建管理员
- `DELETE /api/super/admins/:id` - 删除管理员
- `PUT /api/super/admins/:id/churches` - 更新管理员教会关联

## 安全特性

1. ✅ 权限验证：所有超级管理员接口都验证 `is_super` 标识
2. ✅ 保护措施：不能删除超级管理员账号
3. ✅ 自我保护：不能删除自己的账号
4. ✅ 密码加密：使用 bcrypt 加密存储
5. ✅ JWT认证：所有请求需要有效的token

## 注意事项

1. 超级管理员权限很高，请妥善保管账号密码
2. 删除管理员后无法恢复，请谨慎操作
3. 修改签到URL后，需要重新生成和分发二维码
4. 普通管理员只能看到被分配的教会数据
